<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pm.rc.project">

	<select id="groupProSelect" parameterType="java.util.Map"
		resultType="ProjectDto">
	<![CDATA[
		SELECT P.PR_ID, P.PR_NAME, P.PR_PRORATE, 
		(SELECT TO_DATE(TO_CHAR(P.PR_ENDDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD')
			FROM DUAL) PR_ENDDATE
		FROM RC_PROJECT P
		WHERE P.PR_ID IN (SELECT GP.PR_ID FROM RC_GRPRO GP WHERE GP.GR_ID = #{gr_id}
		AND GP.PR_ID IN (SELECT PM.PR_ID FROM RC_PROMEM PM WHERE PM.MEM_ID = #{mem_id}))
		AND P.PR_DELYN = 'N'
	]]>
	</select>

	<select id="myProSelect" parameterType="java.lang.String"
		resultType="ProjectDto">
	<![CDATA[
		SELECT P.PR_ID, P.PR_NAME, P.PR_PRORATE, 
		(SELECT TO_DATE(TO_CHAR(P.PR_ENDDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD')
			FROM DUAL) PR_ENDDATE
		FROM RC_PROJECT P
		WHERE NOT P.PR_ID IN (SELECT GP.PR_ID FROM RC_GRPRO GP)
		AND P.PR_ID IN (SELECT PR_ID FROM RC_PROMEM WHERE MEM_ID = #{mem_id})
		AND P.PR_DELYN = 'N'
	]]>
	</select>

	<insert id="iProInsert" parameterType="java.util.Map">
		INSERT INTO RC_PROJECT
		(PR_ID, PR_NAME, PR_STARTDATE, PR_ENDDATE, PR_GOAL, PR_ETC)
		VALUES
		(#{pr_id}, #{pr_name}, TO_DATE(#{pr_startdate}, 'YYYY-MM-DD'),
		TO_DATE(#{pr_enddate}, 'YYYY-MM-DD'),
		#{pr_goal}, #{pr_etc})
	</insert>

	<insert id="iPromemInsert" parameterType="java.util.Map">
		INSERT INTO RC_PROMEM
		(PR_ID, MEM_ID, PR_LEVEL)
		VALUES
		(#{pr_id}, #{mem_id}, 'PM')
	</insert>
	
	<insert id="gProInsert" parameterType="java.util.Map">
		INSERT INTO RC_PROJECT (PR_ID, PR_NAME, PR_STARTDATE, PR_ENDDATE, PR_GOAL, PR_ETC)
		VALUES
		(#{pr_id}, #{pr_name}, TO_DATE(#{pr_startdate}, 'YYYY-MM-DD'), TO_DATE(#{pr_enddate}, 'YYYY-MM-DD'),
			#{pr_goal}, #{pr_etc})
	</insert>
	
	<insert id="gPromemInsert" parameterType="java.util.Map">
		INSERT INTO RC_PROMEM (PR_ID, MEM_ID, PR_LEVEL)
		VALUES
		(#{pr_id}, #{mem_id}, 'PM')
	</insert>
	
	<insert id="gGroupProInsert" parameterType="java.util.Map">
		INSERT INTO RC_GRPRO (GR_ID, PR_ID)
		VALUES
		(#{gr_id}, #{pr_id})
	</insert>

	<select id="prDetailSelect" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT P.PR_NAME, M.MEM_NAME, P.PR_MEMCNT, P.PR_GOAL,
		TO_CHAR(P.PR_STARTDATE, 'YYYY-MM-DD') PR_STARTDATE,
		TO_CHAR(P.PR_ENDDATE, 'YYYY-MM-DD') PR_ENDDATE, P.PR_ETC,
		P.PR_SEARCHYN, P.PR_CONDITION
		FROM RC_PROJECT P, RC_MEMBER M
		WHERE P.PR_ID = #{pr_id}
		AND M.MEM_ID =
		(SELECT PM.MEM_ID FROM RC_PROMEM PM WHERE PM.PR_ID = P.PR_ID AND PM.PR_LEVEL = 'PM')
	</select>
	
	<select id="prMemListSelect" parameterType="java.lang.String" resultType="java.util.Map">
		SELECT M.MEM_ID, M.MEM_NAME 
  		FROM RC_MEMBER M
		WHERE M.MEM_ID IN (SELECT P.MEM_ID FROM RC_PROMEM P WHERE P.PR_ID = #{pr_id})
	</select>
	
	<select id="myLevelSelect" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT PM.PR_LEVEL FROM RC_PROMEM PM
		WHERE PM.PR_ID = #{pr_id} AND PM.MEM_ID = #{mem_id}
	</select>
	
	<select id="prManagerSelect" parameterType="java.lang.String" resultType="MemberDto">
		SELECT MEM_ID
		FROM RC_PROMEM
		WHERE PR_LEVEL = 'PM' AND PR_ID = #{pr_id}
	</select>
	
	<update id="projectEdit" parameterType="ProjectDto">
		UPDATE RC_PROJECT SET PR_NAME = #{pr_name}, PR_ENDDATE = #{pr_endDate}, 
			PR_GOAL = #{pr_goal}, PR_SEARCHYN = #{pr_searchYN}, PR_CONDITION = #{pr_condition}
		WHERE PR_ID = #{pr_id}
	</update>
	
	<select id="prMemInsertSearch" parameterType="java.util.Map" resultType="MemberDto">
		SELECT M.MEM_ID, M.MEM_NAME
		FROM RC_MEMBER M
		WHERE NOT M.MEM_ID IN 
		(SELECT PM.MEM_ID FROM RC_PROMEM PM WHERE PM.PR_ID = #{pr_id})
		AND M.MEM_ID IN (SELECT GM.MEM_ID FROM RC_GROUPMEM GM WHERE GM.GR_ID = #{gr_id})
	</select>
	
	<insert id="prMemInsert" parameterType="java.util.Map">
		INSERT INTO RC_PROMEM (PR_ID, MEM_ID)
  		VALUES
  		(#{pr_id}, #{mem_id})
	</insert>
	
	<update id="prMemUpdate" parameterType="java.lang.String">
		UPDATE RC_PROJECT SET PR_MEMCNT = (SELECT COUNT(*) FROM RC_PROMEM WHERE PR_ID = #{pr_id})
  		WHERE PR_ID = #{pr_id}
	</update>
	
	<delete id="prMemDelete" parameterType="java.util.Map">
		DELETE FROM RC_PROMEM 
  		WHERE MEM_ID = #{mem_id} AND PR_ID = #{pr_id} AND PR_LEVEL = 'PIM'
	</delete>
	
	<update id="prMgrEdit_1" parameterType="java.util.Map">
		UPDATE RC_PROMEM SET PR_LEVEL = 'PIM'
		WHERE MEM_ID = (SELECT MEM_ID FROM RC_PROMEM WHERE PR_ID = #{pr_id} AND PR_LEVEL = 'PM')
 			AND PR_ID = #{pr_id}
	</update>
	
	<update id="prMgrEdit_2" parameterType="java.util.Map">
		UPDATE RC_PROMEM SET PR_LEVEL = 'PM'
		WHERE MEM_ID = #{new_id} AND PR_ID = #{pr_id}
	</update>
	
	<select id="memInfoSelect_1" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT M.MEM_ID, M.MEM_NAME, M.MEM_EMAIL, M.MEM_PHONE
		FROM RC_MEMBER M
		WHERE M.MEM_ID = #{mem_id}
	</select>
	
	<select id="memInfoSelect_2" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT P.PR_ID, P.PR_NAME, P.PR_CONDITION
		FROM RC_PROJECT P
		WHERE P.PR_ID IN (SELECT GP.PR_ID FROM RC_GRPRO GP WHERE GP.GR_ID = #{gr_id})
			AND P.PR_ID IN (SELECT PM.PR_ID FROM RC_PROMEM PM WHERE PM.MEM_ID = #{mem_id})
	</select>


</mapper>
