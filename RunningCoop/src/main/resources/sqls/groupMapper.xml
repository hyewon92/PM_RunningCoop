<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pm.rc.groupMapper">

	<resultMap type="MemberDto" id="memDTO">
		<result property="mem_name" column="MEM_NAME" />
		<result property="groupwaitdto.wait_regDate" column="WAIT_REGDATE" />
	</resultMap>
	
	<resultMap type="GroupDto" id="groupdto2">
		<result property="gr_id" column="GR_ID"/>
		<result property="gr_name" column="GR_NAME"/>
		<result property="gr_regDate" column="GR_REGDATE"/>
		<result property="memberdto.mem_name" column="mem_name"/>
	</resultMap>

	<select id="myGrSelect" parameterType="java.util.Map"
		resultType="GroupDto">
		SELECT G.GR_ID , G.GR_NAME FROM RC_GROUP G
		WHERE G.GR_ID IN
		(SELECT GR_ID FROM RC_GROUPMEM WHERE MEM_ID = #{mem_id})
		AND G.GR_DELYN
		= 'N'
	</select>

	<select id="grDetailSelect" parameterType="java.util.Map"
		resultType="java.util.Map">
		SELECT G.GR_ID, G.GR_NAME, M.MEM_NAME, G.GR_MEMCNT,
		G.GR_GOAL,
		TO_CHAR(G.GR_REGDATE, 'YYYY/MM/DD') GR_REGDATE
		,G.GR_SEARCHYN ,
		G.GR_JOINYN
		FROM RC_GROUP G, RC_MEMBER M
		WHERE G.GR_ID =
		#{gr_id} AND M.MEM_ID =
		(SELECT GM.MEM_ID FROM RC_GROUPMEM GM WHERE
		GM.GR_ID = G.GR_ID AND
		GM.GR_LEVEL = 'GM')
	</select>


	<update id="grModify" parameterType="java.util.Map">
		UPDATE RC_GROUP SET GR_GOAL
		= #{gr_goal}, GR_SEARCHYN = #{gr_searchyn} ,
		GR_JOINYN = #{gr_joinyn}
		WHERE GR_ID = #{gr_id}
	</update>

	<select id="allGrSelect" parameterType="java.util.Map" resultMap="groupdto2">
		SELECT 	G.GR_ID, G.GR_NAME, M.MEM_NAME
		FROM 	RC_GROUP G, RC_MEMBER M
		WHERE 	M.MEM_ID IN (
							SELECT 	GM.MEM_ID 
							FROM 	RC_GROUPMEM GM
							WHERE 	GM.GR_ID = G.GR_ID 
									AND GM.GR_LEVEL = 'GM'
						   )
		AND G.GR_NAME LIKE '%'|| #{gr_name} ||'%'
	</select>

	<select id="grMemSelect" parameterType="java.lang.String"
		resultType="MemberDto">
		SELECT M.MEM_ID, M.MEM_NAME FROM RC_MEMBER M
		WHERE M.MEM_ID
		IN (SELECT GM.MEM_ID FROM RC_GROUPMEM GM WHERE GR_ID =
		#{gr_id})
		AND
		M.MEM_DELYN = 'N'
	</select>

	<delete id="grMemDelete1" parameterType="java.util.Map">
		DELETE FROM RC_GROUPMEM
		WHERE MEM_ID = #{mem_id} AND GR_ID = #{gr_id} AND
		GR_LEVEL = 'GIM'
	</delete>

	<update id="grMemDelete2" parameterType="java.lang.String">
		UPDATE RC_GROUP SET
		GR_MEMCNT =
		(SELECT COUNT (*) FROM RC_GROUPMEM WHERE GR_ID = #{gr_id})
		WHERE GR_ID = #{gr_id}
	</update>

	<insert id="grWaitInsert" parameterType="java.util.Map">
		INSERT INTO RC_GRWAIT
		(WAIT_SEQ, MEM_ID, GR_ID, WAIT_CONTENT)
		VALUES
		(GRWAIT_SEQ.NEXTVAL,
		#{mem_id}, #{gr_id}, #{wait_content})
	</insert>

	<select id="grWaitList" parameterType="java.lang.String"
		resultMap="memDTO">
		SELECT M.MEM_NAME mem_name, GW.WAIT_REGDATE wait_regDate
		,M.MEM_ID
		FROM RC_MEMBER M, RC_GRWAIT GW
		WHERE GW.GR_ID = #{gr_id} AND M.MEM_ID =
		GW.MEM_ID AND M.MEM_DELYN ='N'
	</select>


	<insert id="grMemInsert1" parameterType="java.util.Map">
		INSERT INTO RC_GROUPMEM (GR_ID, MEM_ID)
		VALUES (#{gr_id}, #{mem_id})
	</insert>

	<delete id="grMemInsert2" parameterType="java.util.Map">
		DELETE FROM RC_GRWAIT WHERE GR_ID = #{gr_id} AND MEM_ID = #{mem_id}
	</delete>

	<update id="grMemInsert3" parameterType="java.util.Map">
		UPDATE RC_GROUP SET GR_MEMCNT =
		(SELECT COUNT (*) FROM RC_GROUPMEM WHERE GR_ID = #{gr_id})
		WHERE GR_ID = #{gr_id}
	</update>
	
	<delete id="grMemReject" parameterType="java.util.Map">
		DELETE FROM RC_GRWAIT WHERE GR_ID = #{gr_id} AND MEM_ID = #{mem_id}
	</delete>
	
	<insert id="grInsert1" parameterType="java.util.Map" >
		INSERT INTO RC_GROUP (GR_ID, GR_NAME, GR_GOAL)
		VALUES
		(#{gr_id}, #{gr_name}, #{gr_goal})
	</insert>

	<insert id="grInsert2" parameterType="java.util.Map">
		INSERT INTO RC_GROUPMEM (GR_ID, MEM_ID, GR_LEVEL)
		VALUES
		(#{gr_id}, #{mem_id}, 'GM')
	</insert>
	
	
		<select id="createPaging" parameterType="pagingDto" resultMap="groupdto2">
		SELECT *
		FROM ( SELECT ROWNUM RNUM, P.*
		      FROM (
	            SELECT G.GR_ID, G.GR_NAME, M.MEM_NAME, G.GR_REGDATE FROM RC_GROUP G, RC_MEMBER M 
				WHERE M.MEM_ID IN (SELECT GM.MEM_ID FROM RC_GROUPMEM GM WHERE GM.GR_ID = G.GR_ID AND GM.GR_LEVEL = 'GM')
				AND G.GR_NAME LIKE '%'||#{gr_name}||'%'
				ORDER BY G.GR_REGDATE DESC
		      ) P
		    )	
		WHERE RNUM BETWEEN #{start} AND #{last}
	</select>
	<!-- 2. Total Query -->
	<select id="countTotalpaging" resultType="java.lang.Integer" parameterType="pagingDto">
		SELECT NVL(COUNT(*),0)
		FROM RC_GROUP G, RC_MEMBER M
		WHERE M.MEM_ID IN (SELECT GM.MEM_ID FROM RC_GROUPMEM GM WHERE GM.GR_ID = G.GR_ID AND GM.GR_LEVEL = 'GM') AND G.GR_NAME LIKE '%'||#{gr_name}||'%'
	</select>





</mapper>
